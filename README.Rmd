---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
set.seed(42)
```

# predictNMB <a href='https://github.com/RWParsons/predictNMB'><img src='man/figures/logo.png' align="right" height="139" /></a>

<!-- badges: start -->
[![R-CMD-check](https://github.com/RWParsons/predictNMB/workflows/R-CMD-check/badge.svg)](https://github.com/RWParsons/predictNMB/actions)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
<!-- badges: end -->

## Overview

predictNMB is a tool to evaluate clinical prediction models based on their estimated Net Monetary Benefit (NMB).

`{predictNMB}` has two main functions: 

- `do_nmb_sim()`: takes user defined inputs for a given prediction model and population, then evaluates the NMB by performing simulations.
- `screen_simulation_inputs()`: calls `do_nmb_sim()` many times, using a range of values for any of its inputs. This is useful for sensitivity analysis.

## Installation

You can install the development version of predictNMB from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("RWParsons/predictNMB")
```

## Estimating model cutpoints

Hypothetical NMB associated with each square of a confusion matrix must first be defined.

```{r}
library(predictNMB)

fx_nmb <- function() {
  c(
    "TP" = -75, # True positive
    "FP" = -10, # False positive
    "TN" = 0,  # True negative
    "FN" = -100 # False negative
  )
}

fx_nmb()

```

Required arguments:

- `n_sims`: number of simulations to run. More simulations take longer, but are more stable
<br>
- `event_rate`: event incidence rate, or the proportion of patients experiencing the event
<br>
- `sim_auc`: vector of hypothetical AUCs; e.g. `seq(0.7, 0.95, 0.05)` or `c(0.75, 0.80, 0.85)`
<br>
- `n_valid`: number of samples the validation set draws within each simulation (evaluating the NMB under each cutpoint)
<br>
- `fx_nmb_training`: function-defined vector used to get cutpoints on the training set. Recommended to use constant values
<br>
- `fx_nmb_evaluation`: function-defined vector used to get cutpoints on the evaluation set. Recommended to use sampled values
<br>
- (Optional) Users can pass a cluster as the `cl` argument. If it is passed, the simulations are run in parallel (faster).
<br>

```{r warning=FALSE}
library(parallel)
cl <- makeCluster(detectCores())
sim_screen_obj <- screen_simulation_inputs(
  n_sims = 1000, n_valid = 10000, sim_auc = seq(0.7, 0.95, 0.05), event_rate = 0.1,
  fx_nmb_training = fx_nmb, fx_nmb_evaluation = fx_nmb,
  cutpoint_methods = c("all", "none", "youden", "value_optimising"), cl = cl
)
```

`plot()` can be used to generate plots of the many simulations.

```{r}
plot(sim_screen_obj)
```

The plot method includes additional arguments to rename the methods using a named vector. It can also be used to visualise cutpoints or the Incremental Net Monetary Benefit (INB) when there's a known reference strategy.

```{r}
plot(
  sim_screen_obj, 
  rename_vector=c("Treat All" = "all", "Treat None" = "none", "Youden Index" = "youden", "Value-Optimising" = "value_optimising")
)
plot(
  sim_screen_obj, 
  rename_vector=c("Treat All" = "all", "Treat None" = "none", "Youden Index" = "youden", "Value-Optimising" = "value_optimising"),
  what="inb",
  inb_ref_col="Treat All"
)
```

By default, the median (dot), 95% interval (thick vertical line), range (skinny vertical line), and lines between points are shown. All except the dots can be optionally turned off or on, and the width of the interval can be controlled with `ci`.

```{r}
plot(
  sim_screen_obj,
  plot_line = FALSE,
  plot_range = FALSE,
  plot_ci = 0.8
)
plot(
  sim_screen_obj,
  plot_line = TRUE,
  plot_range = FALSE,
  plot_ci = 0
)
```

The simulations for a given set of inputs can be accessed from our `predictNMBscreen` object (`sim_screen_obj`). These are the same as the output from `do_nmb_sim()` and have their own methods as well. 

```{r}
sim_screen_obj$simulations
sim_obj <- sim_screen_obj$simulations[[1]]

sim_obj
```

Here, using the `predictNMBsim` object, the plot shows the median as the solid bar within the distribution and the light blue portion of the distribution is the 95% interval (level can be changed using the `ci` argument).

```{r}
plot(sim_obj)
plot(sim_obj, ci=0.50)
```

The plot methods for both the `predictNMBscreen` and `predictNMBsim` objects have almost the same usage of arguments.

```{r}
plot(
  sim_obj, 
  rename_vector=c("Treat All" = "all", "Treat None" = "none", "Youden Index" = "youden", "Value-Optimising" = "value_optimising")
)
plot(
  sim_obj, 
  rename_vector=c("Treat All" = "all", "Treat None" = "none", "Youden Index" = "youden", "Value-Optimising" = "value_optimising"),
  what="inb",
  inb_ref_col="Treat All"
)
```

## Further reading
The vignette, Introduction to predictNMB, is available here (insert link)

## Related work
This R package is based on previous work on value-optimising cutpoints for the economic evaluation of clinical prediction models. It can be accessed here (insert link).
